# PHP Exception Handling

The `Airbrake-PHP` library quickly and easily integrates into any PHP project, giving you and your team access to real-time error monitoring and reports throughout your application's entire life cycle.  With automatic, instantaneous error and exception notifications at your fingertips, you'll be constantly aware of your application's health, including any issues that may arise.  Best of all, with `Airbrake's` robust web dashboard cataloging every error event that occurs, you and your team can immediately dive into the exact details of what went wrong, making it easy to quickly recognize and resolve problems.

`Airbrake-PHP` supports easy installation via the popular `Composer` dependency manager for PHP so you'll be up and running in just a few minutes.  While `Airbrake-PHP` works great out of the box for all manner of PHP applications, it also supports integration with many other popular frameworks and libraries such as `Laravel`, `Symfony`, `CakePHP`, and `Monolog` through powerful community-created packages.  Check out all the great features `Airbrake-PHP` has to offer and get started with powerful, robust error management using `Airbrake` today!

## Features

`Airbrake-PHP` is packed with PHP-centric features designed with the PHP developer in mind.  Whether you're creating a plain PHP project or using a powerful framework like `CakePHP`, `Symfony`, or `Laravel`, `Airbrake-PHP` offers seamless integration so your team can receive immediate error reports through the `Airbrake` dashboard.  Beyond frameworks, all `Airbrake` projects can be easily integrated with popular outside services such as `GitHub`, `Trello`, `Slack`, `JIRA`, and many more, providing your organization with up-to-date alerts the moment something goes wrong with your application.

Have a glance at just a handful of the great features below or head over to the full [documentation](https://github.com/airbrake/phpbrake) to find out everything `Airbrake-PHP` has on offer for your next PHP application!

### Extensive Framework Support

While `Airbrake-PHP` can easily be used with every plain PHP application, it can also be quickly integrated with some of the most popular PHP frameworks on the market, including [Laravel](#integrating-with-laravel), [Symfony](#integrating-with-symfony), and [CakePHP](#integrating-with-cakephp).  In just a matter of minutes you'll have `Airbrake-PHP` running alongside your existing framework-based PHP applications.  This ensures that all exceptions are automatically and immediately reported through the `Airbrake` dashboard with very little code or configuration requirements.  However, if you need to make adjustments to the default settings, `Airbrake-PHP` comes with an in-depth [configuration API](https://github.com/airbrake/phpbrake#extra-configuration-options) that lets you tweak the library to just what you need.

### Unlimited Custom Parameters

Notifications generated by `Airbrake-PHP` automatically include all basic exception information such as the error message, call stack, PHP language, OS, and much more.  However, in many cases you'll want additional information associated with a particular exception, which is why `Airbrake-PHP` allows for unlimited custom parameters to be attached to each notification as you see fit.  Simply create a new notification via the `Airbrake\Instance::buildNotice()` method, then populate the `['context']` array field with any and all additional information you need:

```php
try {
    throw new Exception('Uh oh, something broke!');
} catch (Exception $e) {
    // Create a new notice instance and attach the exception.
    $notice = Airbrake\Instance::buildNotice($e);
    // Add the 'android' field to the context array with additional values.
    $notice['context']['android'] = array(
        'version' => '7.1.2',
        'timestamp' => time(),
    );
    // Send the created noticed to Airbrake.io.
    Airbrake\Instance::sendNotice($notice);
}
```

Now this particular exception occurrence, when reported through the `Airbrake` dashboard, will include the extra `context` content we provided, in addition to the basic information generated by `Airbrake-PHP`, as seen below:

```json
{
  "android": {
    "timestamp": 1494040344,
    "version": "7.1.2"
  },
  "hostname": "ubuntu",
  "language": "php 7.0.15-0ubuntu0.16.04.4",
  "notifier": {
    "name": "phpbrake",
    "url": "https://github.com/airbrake/phpbrake",
    "version": "0.2.2"
  },
  "os": "Linux ubuntu 4.8.0-49-generic #52~16.04.1-Ubuntu SMP Thu Apr 20 10:55:59 UTC 2017 x86_64",
  "remoteAddr": "...",
  "remoteCountry": "United States",
  "remoteCountryCode": "US"
}
```

### Robust Exception Filtering

`Airbrake-PHP` makes it simple to filter through all `notices` generated by the library.  This makes it easy to perform a wide range of tasks such as adding custom data to all `notices`, removing sensitive data from `Airbrake` reports, and even ignoring specific exceptions based on their PHP class type.

To get started simply create a new `notifier` instance, then use the `Airbrake\Notifier->addFilter()` method to start filtering notices based on whatever criteria you need:

```php
// Create new Notifier instance.
$notifier = new Airbrake\Notifier(array(
    'projectId' => PROJECT_ID,
    'projectKey' => 'PROJECT_API_KEY',
));

// Add environment data to all notices.
$notifier->addFilter(function($notice) {
    $notice['context']['environment'] = 'production';
    return $notice;
});

// Add filter to remove sensitive data before submission.
$notifier->addFilter(function($notice) {
    if (isset($notice['params']['password'])) {
        unset($notice['params']['password']);
    }
    return $notice;
});

// Add filter to ignore all Exception class types.
$notifier->addFilter(function($notice) {
    if ($notice['errors'][0]['type'] == 'Exception') {
        // Ignore this exception.
        return null;
    }
    return $notice;
});
```

Head over to the [documentation](https://github.com/airbrake/phpbrake#adding-custom-data-to-the-notice) for full details on filtering with `Airbrake-PHP`.

## Installation

#### Install via Composer

To install `Airbrake-PHP` with `Composer` simply issue the `composer require` command in the terminal from your project's root directory:

```bash
$ composer require airbrake/phpbrake
Using version ^0.2.3 for airbrake/phpbrake
./composer.json has been created
Loading composer repositories with package information
Updating dependencies (including require-dev)
Package operations: 1 install, 0 updates, 0 removals
  - Installing airbrake/phpbrake (v0.2.3): Loading from cache
airbrake/phpbrake suggests installing guzzlehttp/guzzle (Allows for implementation of the Guzzle HTTP client)
Writing lock file
Generating autoload files
```

Though not required, we also recommend you install the `guzzle` HTTP client, which `Airbrake-PHP` will use if available:

```bash
$ composer require guzzlehttp/guzzle
Using version ^6.2 for guzzlehttp/guzzle
./composer.json has been updated
Loading composer repositories with package information
Updating dependencies (including require-dev)
Package operations: 4 installs, 0 updates, 0 removals
  - Installing guzzlehttp/promises (v1.3.1): Loading from cache
  - Installing psr/http-message (1.0.1): Loading from cache
  - Installing guzzlehttp/psr7 (1.4.2): Loading from cache
  - Installing guzzlehttp/guzzle (6.2.3): Loading from cache
Writing lock file
Generating autoload files
```

## Usage

Once the library is installed, making use of `Airbrake-PHP` is simple.  You can use it within a plain PHP project or dive right into a specific framework integration if needed.

### Using with Plain PHP

To setup the basic form of `Airbrake-PHP`, which works with any PHP application, start by creating a new instance of `Airbrake\Notifier` and pass in your `Project ID` and `Project API Key`, both of which can be found on the right-hand side of the `Project Settings` page from the `Airbrake` dashboard.  You'll also want to set the global notifier instance via the `Airbrake\Instance::set()` method, then register the error and exception handlers through the `Airbrake\ErrorHandler` class:

```php
// Create new Notifier instance.
$notifier = new Airbrake\Notifier(array(
    'projectId' => PROJECT_ID,
    'projectKey' => 'PROJECT_API_KEY',
));

// Set global notifier instance.
Airbrake\Instance::set($notifier);

// Register error and exception handlers.
$handler = new Airbrake\ErrorHandler($notifier);
$handler->register();
```

That's all the configuration that's required!  You can now send `notices` to `Airbrake` by calling the `Airbrake\Instance::notify()` method:

```php
// Somewhere in the app...
try {
    throw new Exception('Uh oh, something went wrong!');
} catch(Exception $e) {
    Airbrake\Instance::notify($e);
}
```

### Integrating with Laravel

To integrate `Airbrake-PHP` with Laravel start by installing the [`laravel-airbrake`](https://github.com/TheoKouzelis/laravel-airbrake) package:

```bash
$ composer require kouz/laravel-airbrake
Using version ^0.2.0 for kouz/laravel-airbrake
...
```

Next, add the package to the `providers` list in `config/app.php`:

```php
<?php
  //config/app.php
  
  'providers' => [
    Kouz\Providers\AirbrakeServiceProvider::class,
  ],
```

Finally, publish with the associated `--provider` parameter and then fill out the `config/airbrake.php` file with your `Project ID` and `Project API Key` from the `Airbrake` dashboard:

```bash
$ php artisan vendor:publish --provider="Kouz\Providers\AirbrakeServiceProvider"
```

Now you're all set and can quickly generate notifications within your Laravel app:

```php
//app/Exceptions/Handler.php

/**
 * Report or log an exception.
 *
 * This is a great spot to send exceptions to Sentry, Bugsnag, etc.
 *
 * @param  \Exception  $e
 * @return void
 */
public function report(Exception $e)
{
    if ($this->shouldReport($e)) {
        $airbrakeNotifier = \App::make('Airbrake\Notifier');
        $airbrakeNotifier->notify($e);
    }

    parent::report($e);
}
```

_Note: The Laravel + `Airbrake-PHP` integration package is community-created and is not officially supported by `Airbrake`.  Please see the [documentation](https://github.com/TheoKouzelis/laravel-airbrake) for more details._

### Integrating with Symfony

Just as with Laravel, integrating `Airbrake-PHP` into a Symfony application begins by installing the package via Composer:

```bash
$ composer require aminin/airbrake-bundle
Using version ^0.1.3 for aminin/airbrake-bundle
...
```

Next, add the installed bundle to your `app/AppKernel.php` file:

```php
<?php
// app/AppKernel.php

public function registerBundles()
{
    $bundles = array(
        // ...
        new Ami\AirbrakeBundle\AmiAirbrakeBundle(),
    );
}
```

Finally, include your `Project ID` and `Project API Key` in the `config.yml` file:

```yaml
# app/config/config.yml
ami_airbrake:
    project_id:  PROJECT_ID
    project_key: PROJECT_API_KEY
```

Once installed and configured, you don't need to manually create `notices` to send exceptions to `Airbrake`.  In fact, the package will automatically send all exceptions and errors to `Airbrake`.

_Note: The Symfony + `Airbrake-PHP` integration package is community-created and is not officially supported by `Airbrake`.  Please see the [documentation](https://github.com/aminin/airbrake-bundle) for more details._

### Integrating with CakePHP

Integrating `Airbrake-PHP` into the normal CakePHP error workflow is a little bit tricker than other integrations, primarily because it requires the creation of a new `AirbrakeHandler` class file.

Start by modifying your `config/bootstrap.php` file to `use` the new `AirbrakeHandler` class that will be created shortly, while also registering the new handler:

```php
<?php
// ...

use App\Error\AirbrakeHandler;

// ...

/**
 * Register application error and exception handlers.
 */
$isCli = PHP_SAPI === 'cli';
if ($isCli) {
    (new ConsoleErrorHandler(Configure::read('Error')))->register();
} else {
    (new AirbrakeHandler(Configure::read('Error')))->register();
```

Now create a new file at `src/Error/AirbrakeHandler.php` and paste the following code.  As usual, be sure to replace the `Project ID` and `Project API Key` values with your own settings from the `Airbrake` project dashboard:

```php
<?php
namespace App\Error;

use Cake\Core\Configure;
use Cake\Error\ErrorHandler;

use Airbrake\Notifier as AirbrakeNotifier;
use Airbrake\ErrorHandler as AirbrakeErrorHandler;
use Airbrake\Instance as AirbrakeInstance;

/**
 * Airbrake Handler, this class allows for an error or exception to be sent to airbrake, 
 * while also allowing the normal CakePHP error flow
 */
class AirbrakeHandler extends ErrorHandler
{
    protected $_airbrakeHandler;

    /**
     * Constructor
     *
     * @param array $options The options for error handling.
     */
    public function __construct($options = [])
    {
        $this->setupAirbrake();

        $options['debug']  = Configure::read('debug');
        parent::__construct($options);
    }

    /**
     * Setup airbrake instance and register shutdown function
     */
    protected function setupAirbrake()
    {
        // Create new Notifier instance.
        $notifier = new Airbrake\Notifier([
          'projectId' => PROJECT_ID,
          'projectKey' => 'PROJECT_API_KEY'
        ]);

        // Set global notifier instance.
        AirbrakeInstance::set($notifier);

        // Setup the Airbrake Error Handler.
        $this->_airbrakeHandler = new AirbrakeErrorHandler($notifier);

        // Register shutdown function manually, since we're not calling $handler->register();
        register_shutdown_function([$this->_airbrakeHandler, 'onShutdown']);
    }

    /**
     * {@inheritDoc}
     */
    public function handleError($code, $description, $file = null, $line = null, $context = null)
    {
        $this->_airbrakeHandler->onError($code, $description, $file, $line);
        return parent::handleError($code, $description, $file, $line, $context);
    }

    /**
     * {@inheritDoc}
     */
    public function wrapAndHandleException($exception)
    {
        $this->_airbrakeHandler->onException($exception);
        parent::wrapAndHandleException($exception);
    }
}
```

That's all there is to it.  Your CakePHP application should now send appropriate errors and exceptions to the `Airbrake` dashboard!

_Note: The CakePHP + `Airbrake-PHP` integration package is community-created and is not officially supported by `Airbrake`.  Please see [this gist](https://gist.github.com/mauriciovillalobos/01a97f9ee6179ad70b17d54f37cc5010) for more details._